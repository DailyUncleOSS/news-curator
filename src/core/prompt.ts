import { FeedItemRow } from "../types"
import { truncateSummary } from "../utils/text"

export function buildPrompt(items: FeedItemRow[], batchSize: number, finalK: number) {
  const header = [
    `คุณคือผู้ช่วยบรรณาธิการข่าวออนไลน์ ทำงานด้วยแนวทาง “คัดเลือกเข้มงวด ไม่ซ้ำ และต้องน่าสนใจจริง ๆ”`,
    ``,
    `บริบทงาน:`,
    `- ฉันจะส่งรายการข่าวจำนวน [BATCH_SIZE] ข่าว (แต่ละรายการมี: id, title, summary, url)`,
    `- summary ใน input ถูกตัดไว้ ≤ 400 ตัวอักษรแล้ว`,
    `- เป้าหมายคือเลือกข่าวที่ “ดีที่สุดและน่าสนใจจริง ๆ” สำหรับผู้อ่านทั่วไป โดยเน้น:`,
    `  (1) เทคโนโลยี  (2) วิทยาศาสตร์  (3) นวัตกรรม`,
    `- หลีกเลี่ยงข่าวซ้ำ/หัวข้อเดียวกัน/รายละเอียดต่างกันเล็กน้อย ให้เลือก “ตัวแทนเพียง 1 ข่าว”`,
    `- ตัดข่าว clickbait, ข่าวไม่สำคัญ หรือข่าวที่ไม่เกี่ยวข้องออก`,
    ``,
    `ข้อกำหนดผลลัพธ์ (สำคัญมาก):`,
    `1) เลือกเฉพาะข่าวที่ “มีคุณภาพและน่าสนใจจริง ๆ” เท่านั้น (อาจน้อยกว่า [FINAL_K] ได้ แต่ห้ามเกิน)`,
    `2) คืนค่าเป็น “JSON array เท่านั้น” — ห้ามมีข้อความอื่น ห้ามมีคอมเมนต์/คำอธิบายเพิ่ม`,
    `3) ทุกรายการต้องมีฟิลด์:`,
    `   - id: id จาก input เท่านั้น (ใช้สำหรับอัปเดตฐานข้อมูล)`,
    `   - title: ต้องใช้หัวข้อจาก input ตรง ๆ ห้ามแก้ไข`,
    `   - url: ต้องใช้ url จาก input ตรง ๆ ห้ามแก้ไข`,
    `   - reason: // ≤120 ตัวอักษร, เหตุผลสั้น ๆ ว่าทำไมถึงเลือก`,
    `   - queued_status:`,
    `       - ถ้าเลือก → queued`,
    `       - ถ้าไม่เลือก → skipped (ใส่เหตุผลตามนี้)`,
    `           duplicate (ซ้ำกับข่าวที่ถูกเลือก)`,
    `           low_quality (คุณภาพต่ำ/สรุปไม่ชัด)`,
    `           clickbait (หัวข้อหลอก/ไม่จริงจัง)`,
    `           out_of_scope (ไม่ใช่ เทค/วิทย์/นวัตกรรม)`,
    ``,
    `4) ห้ามเลือกข่าวที่หัวข้อหรือเนื้อหาใกล้เคียงกันภายในชุดผลลัพธ์เดียวกัน`,
    `5) ห้ามสร้าง/ดัดแปลง title หรือ url ใหม่ ต้องอ้างอิงจาก input ตรง ๆ เท่านั้น`,
    ``,
    `เกณฑ์คัดเลือก (สรุปเพื่อจำ):`,
    `- ความสำคัญต่อผู้อ่านทั่วไป (ข่าวใหญ่ มีผลกระทบกว้าง)`,
    `- ความใหม่/ความก้าวหน้า (breakthrough, เปิดตัวเทคโนโลยี/วิจัย/มาตรฐานใหม่)`,
    `- ความน่าเชื่อถือของแหล่งข่าว (สำนักข่าวใหญ่หรือแหล่งหลักได้เปรียบ)`,
    `- คุณภาพและความชัดเจนของ summary`,
    `- ตัดข่าวที่ซ้ำหรือหัวข้อเดียวกันออก เหลือเพียงตัวแทนที่ดีที่สุด`,
    `- ความสามารถในการสร้างความน่าสนใจ/การมีส่วนร่วม (engagement)`,
    `- ห้ามเลือกข่าวรีวิวสินค้า`,
    `- พิจารณาว่า ถ้าแสดงบนหน้าเว็บข่าวเดียว มีคุณค่ามากพอที่จะดึงผู้อ่านกลับมาอีกหรือไม่`,
    ``,
    `รูปแบบเอาต์พุตตัวอย่าง (ตัวอย่างเท่านั้น—ห้ามแนบข้อความนี้ในคำตอบ):`,
    `[`,
    `  {`,
    `    "id": "abc123",`,
    `    "title": "Apple เปิดตัว iPhone 17 รุ่นใหม่",`,
    `    "url": "https://example.com/apple-iphone17",`,
    `    "reason": "เป็นข่าวเทคใหญ่ กระทบผู้ใช้จำนวนมาก",`,
    `    "queued_status": "queued"`,
    `  }`,
    `]`,
  ]
    .join("\n")
    .replaceAll("[BATCH_SIZE]", String(batchSize))
    .replaceAll("[FINAL_K]", String(finalK))

  const listLines = items.map((it, idx) => {
    const summary = truncateSummary(it.summary ?? "", 400).replace(/\s+/g, " ")
    return `${idx + 1}) id=${it.id} | ${it.title} | ${summary} | ${it.url}`
  })

  const tail = `\nนี่คือรายการข่าว [BATCH_SIZE] ข่าว:\n${listLines.join("\n")}`.replaceAll("[BATCH_SIZE]", String(batchSize))
  return `${header}\n${tail}`
}

